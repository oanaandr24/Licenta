<app-header></app-header>
<div class="page-container">
  <!-- <div class="flex justify-content-start mt-2 -ml-3"> 
    <p-button [text]="true" (click)="onBack()" icon="pi pi-arrow-left" iconPos="left" severity="contrast" label="Înapoi"></p-button>
  </div> -->
  <div class="flex justify-content-between align-items-center">
    <h2>Facturi</h2>
  </div>
  <p-card>
    <div class="flex align-items-center justify-content-between">
      <div class="flex align-items-center gap-3">
        <label
          >Alege apartamentul pentru care dorești să vizualizezi secțiunea
          <strong>Facturi</strong></label
        >
        <p-dropdown
          [options]="apartments"
          [(ngModel)]="selectedAp"
          placeholder="Alege apartamentul"
          (ngModelChange)="onApSelection()"
        ></p-dropdown>
      </div>
      <div *ngIf="apCode">
        <p-button
          label="Adaugă factură"
          [style]="{ width: '12em' }"
          (click)="addBill()"
          styleClass="addButton"
        ></p-button>
      </div>
    </div>
    <div *ngIf="bills.length > 0">
      <p-table
        #dt1
        [value]="bills"
        [paginator]="true"
        [rows]="5"
        responsiveLayout="scroll"
        selectionMode="single"
        [(selection)]="selectedBill"
        (onRowSelect)="openModal()"
        [globalFilterFields]="['type', 'dueDate', 'paymentValue', 'status']"
      >
        <ng-template pTemplate="caption">
          <div class="flex justify-content-between">
            <p>
              Vezi facturile aferente apartamentului
              <strong>{{ apCode }}</strong>
            </p>
            <div class="flex">
              <p-iconField iconPosition="left" class="ml-auto">
                <p-inputIcon>
                  <i class="pi pi-search"></i>
                </p-inputIcon>
                <input
                  pInputText
                  type="text"
                  (input)="applyFilterGlobal($event, 'contains')"
                  placeholder="Caută"
                />
              </p-iconField>
            </div>
          </div>
        </ng-template>
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="type">
              Tip <p-sortIcon field="type"></p-sortIcon>
            </th>
            <th pSortableColumn="dueDate">
              Scadență <p-sortIcon field="dueDate"></p-sortIcon>
            </th>
            <th pSortableColumn="paymentValue">
              Valoare <p-sortIcon field="paymentValue"></p-sortIcon>
            </th>
            <th pSortableColumn="status">
              Status <p-sortIcon field="status"></p-sortIcon>
            </th>
            <th pSortableColumn="pdfFile">
              Factură PDF <p-sortIcon field="pdfFile"></p-sortIcon>
            </th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-bill>
          <tr [pSelectableRow]="bill">
            <td>{{ bill.type }}</td>
            <td>{{ bill.dueDate }}</td>
            <td>{{ bill.paymentValue }} RON</td>
            <td>
              <p-tag
                [value]="bill.status"
                [severity]="getSeverity(bill.status)"
              />
            </td>
            <td>
              <p-button
                *ngIf="bill.pdfFile"
                type="button"
                class="p-button-sm"
                [outlined]="true"
                (click)="
                  downloadPdf(bill.pdfFile, 'factura_' + bill.number + '.pdf')
                "
              >Descarcă PDF <i class="pi pi-download" style="margin-left: 0.5em;"></i></p-button>
              <span *ngIf="!bill.pdfFile">N/A</span>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
    <div class="mt-3" *ngIf="showNoBillsMessage">
      <strong>Nu există facturi aferente acestui apartament. </strong>
    </div>
  </p-card>

  <app-bills-modal
    [displayModal]="displayModal"
    (displayModalChange)="displayModal = $event"
    (reloadTable)="reloadTable($event)"
    [selectedBill]="selectedBill"
    [apCode]="apCode"
  ></app-bills-modal>
</div>
